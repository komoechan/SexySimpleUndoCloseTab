const languageTexts = {
    zh: {
        title: 'Êâ©Â±ïËÆæÁΩÆ',
        themeLabel: '‰∏ªÈ¢ò:',
        themeSystem: 'Ë∑üÈöèÁ≥ªÁªü',
        themeLight: 'ÊµÖËâ≤',
        themeDark: 'Ê∑±Ëâ≤',
        languageLabel: 'üåêËØ≠Ë®Ä:',
        maxRecentLabel: 'ÊúÄÂ§ßËÆ∞ÂΩïÊï∞:',
        maxRecentHelp: 'ËÆæÁΩÆÊúÄËøëÂÖ≥Èó≠Ê†áÁ≠æÈ°µÁöÑÊúÄÂ§ßËÆ∞ÂΩïÊï∞Èáè (1-20000)',
        popupWidthLabel: 'ÂºπÁ™óÂÆΩÂ∫¶:',
        popupWidthHelp: 'ËÆæÁΩÆÂºπÂá∫Á™óÂè£ÁöÑÂÆΩÂ∫¶ (300-800ÂÉèÁ¥†)',
        showTabCountLabel: 'ÊòæÁ§∫Ê†áÁ≠æÈ°µÊï∞Èáè:',
        navigationPositionLabel: 'ÂØºËà™‰ΩçÁΩÆ:',
        pageModeLabel: 'ÁøªÈ°µÊ®°Âºè:',
        navigationPositionTop: 'È°∂ÈÉ®',
        navigationPositionBottom: 'Â∫ïÈÉ®',
        pageModePagination: 'ÂàÜÈ°µÊåâÈíÆ',
        pageModeInfinite: 'ÁÄëÂ∏ÉÊµÅ'
    },
    en: {
        title: 'Extension Options',
        themeLabel: 'Theme:',
        themeSystem: 'System',
        themeLight: 'Light',
        themeDark: 'Dark',
        languageLabel: 'üåêLanguage:',
        maxRecentLabel: 'Max Recent Items:',
        maxRecentHelp: 'Set the maximum number of recently closed tabs (1-20000)',
        popupWidthLabel: 'Popup Width:',
        popupWidthHelp: 'Set the width of the popup window (300-800 pixels)',
        showTabCountLabel: 'Show Tab Count:',
        navigationPositionLabel: 'Navigation Position:',
        pageModeLabel: 'Page Mode:',
        navigationPositionTop: 'Top',
        navigationPositionBottom: 'Bottom',
        pageModePagination: 'Pagination',
        pageModeInfinite: 'Infinite'
    },
    ja: {
        title: 'Êã°ÂºµÊ©üËÉΩ„ÅÆË®≠ÂÆö',
        themeLabel: '„ÉÜ„Éº„Éû:',
        themeSystem: '„Ç∑„Çπ„ÉÜ„É†',
        themeLight: '„É©„Ç§„Éà',
        themeDark: '„ÉÄ„Éº„ÇØ',
        languageLabel: 'üåêË®ÄË™û:',
        maxRecentLabel: 'ÊúÄÂ§ßÂ±•Ê≠¥Êï∞:',
        maxRecentHelp: 'ÊúÄËøëÈñâ„Åò„Åü„Çø„Éñ„ÅÆÊúÄÂ§ßÂ±•Ê≠¥Êï∞„ÇíË®≠ÂÆö (1-20000)',
        popupWidthLabel: '„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÂπÖ:',
        popupWidthHelp: '„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆÂπÖ„ÇíË®≠ÂÆö (300-800„Éî„ÇØ„Çª„É´)',
        showTabCountLabel: '„Çø„ÉñÊï∞„ÇíË°®Á§∫:',
        navigationPositionLabel: '„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥‰ΩçÁΩÆ:',
        pageModeLabel: '„Éö„Éº„Ç∏„É¢„Éº„Éâ:',
        navigationPositionTop: '‰∏äÈÉ®',
        navigationPositionBottom: '‰∏ãÈÉ®',
        pageModePagination: '„Éö„Éº„Ç∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥',
        pageModeInfinite: '„Ç§„É≥„Éï„Ç£„Éã„ÉÜ„Ç£„Çπ„ÇØ„É≠„Éº„É´'
    },
    ko: {
        title: 'ÌôïÏû• ÏÑ§Ï†ï',
        themeLabel: 'ÌÖåÎßà:',
        themeSystem: 'ÏãúÏä§ÌÖú',
        themeLight: 'ÎùºÏù¥Ìä∏',
        themeDark: 'Îã§ÌÅ¨',
        languageLabel: 'üåêÏñ∏Ïñ¥:',
        maxRecentLabel: 'ÏµúÎåÄ ÏµúÍ∑º Ìï≠Î™©:',
        maxRecentHelp: 'ÏµúÍ∑º Îã´ÏùÄ ÌÉ≠Ïùò ÏµúÎåÄ Ìï≠Î™© Ïàò ÏÑ§Ï†ï (1-20000)',
        popupWidthLabel: 'ÌåùÏóÖ ÎÑàÎπÑ:',
        popupWidthHelp: 'ÌåùÏóÖ Ï∞ΩÏùò ÎÑàÎπÑ ÏÑ§Ï†ï (300-800ÌîΩÏÖÄ)',
        showTabCountLabel: 'ÌÉ≠ Ïàò ÌëúÏãú:',
        navigationPositionLabel: 'ÌÉêÏÉâ ÏúÑÏπò:',
        pageModeLabel: 'ÌéòÏù¥ÏßÄ Î™®Îìú:',
        navigationPositionTop: 'ÏÉÅÎã®',
        navigationPositionBottom: 'ÌïòÎã®',
        pageModePagination: 'ÌéòÏù¥ÏßÄ ÌÉêÏÉâ',
        pageModeInfinite: 'Î¨¥Ìïú Ïä§ÌÅ¨Î°§'
    },
    fr: {
        title: 'Options de l‚Äôextension',
        themeLabel: 'Th√®me:',
        themeSystem: 'Syst√®me',
        themeLight: 'Clair',
        themeDark: 'Sombre',
        languageLabel: 'üåêLangue:',
        maxRecentLabel: 'Articles r√©cents max:',
        maxRecentHelp: 'D√©finir le nombre maximum d‚Äôonglets r√©cemment ferm√©s (1-20000)',
        popupWidthLabel: 'Largeur de la fen√™tre:',
        popupWidthHelp: 'D√©finir la largeur de la fen√™tre contextuelle (300-800 pixels)',
        showTabCountLabel: 'Afficher le nombre d\'onglets:',
        navigationPositionLabel: 'Position de navigation:',
        pageModeLabel: 'Mode de pagination:',
        navigationPositionTop: 'Haut',
        navigationPositionBottom: 'Bas',
        pageModePagination: 'Pagination',
        pageModeInfinite: 'Infini'
    },
    de: {
        title: 'Erweiterungsoptionen',
        themeLabel: 'Thema:',
        themeSystem: 'System',
        themeLight: 'Hell',
        themeDark: 'Dunkel',
        languageLabel: 'üåêSprache:',
        maxRecentLabel: 'Maximale k√ºrzliche Elemente:',
        maxRecentHelp: 'Maximale Anzahl k√ºrzlich geschlossener Tabs festlegen (1-20000)',
        popupWidthLabel: 'Popup-Breite:',
        popupWidthHelp: 'Breite des Popup-Fensters festlegen (300-800 Pixel)',
        showTabCountLabel: 'Tab-Anzahl anzeigen:',
        navigationPositionLabel: 'Navigation Position:',
        pageModeLabel: 'Seitenmodus:',
        navigationPositionTop: 'Oben',
        navigationPositionBottom: 'Unten',
        pageModePagination: 'Seitennavigation',
        pageModeInfinite: 'Unendliche Scrollung'
    },
    es: {
        title: 'Opciones de la extensi√≥n',
        themeLabel: 'Tema:',
        themeSystem: 'Sistema',
        themeLight: 'Claro',
        themeDark: 'Oscuro',
        languageLabel: 'üåêIdioma:',
        maxRecentLabel: 'Elementos recientes m√°ximos:',
        maxRecentHelp: 'Establecer el n√∫mero m√°ximo de pesta√±as cerradas recientemente (1-20000)',
        popupWidthLabel: 'Ancho de la ventana emergente:',
        popupWidthHelp: 'Establecer el ancho de la ventana emergente (300-800 p√≠xeles)',
        showTabCountLabel: 'Mostrar recuento de pesta√±as:',
        navigationPositionLabel: 'Posici√≥n de navegaci√≥n:',
        pageModeLabel: 'Modo de paginaci√≥n:',
        navigationPositionTop: 'Arriba',
        navigationPositionBottom: 'Abajo',
        pageModePagination: 'Paginado',
        pageModeInfinite: 'Infinito'
    }
};

function updateLanguageTexts(language) {
    const texts = languageTexts[language];
    if (!texts) {
        console.error(`Language texts not found for language: ${language}`);
        return;
    }
    document.querySelector('h1').textContent = texts.title;
    document.querySelector('label[for="themeSelect"]').textContent = texts.themeLabel;
    document.querySelector('option[value="light"]').textContent = texts.themeLight;
    document.querySelector('option[value="dark"]').textContent = texts.themeDark;
    document.querySelector('label[for="languageSelect"]').textContent = texts.languageLabel;
    document.querySelector('label[for="maxRecent"]').textContent = texts.maxRecentLabel;
    document.querySelectorAll('.help-text')[0].textContent = texts.maxRecentHelp;
    document.querySelector('label[for="popupWidth"]').textContent = texts.popupWidthLabel;
    document.querySelectorAll('.help-text')[1].textContent = texts.popupWidthHelp;
    document.querySelector('label[for="showTabCount"]').textContent = texts.showTabCountLabel;
    document.querySelector('label[for="navigationPosition"]').textContent = texts.navigationPositionLabel;
    document.querySelector('option[value="top"]').textContent = texts.navigationPositionTop;
    document.querySelector('option[value="bottom"]').textContent = texts.navigationPositionBottom;
    document.querySelector('label[for="pageMode"]').textContent = texts.pageModeLabel;
    document.querySelector('option[value="pagination"]').textContent = texts.pageModePagination;
    document.querySelector('option[value="infinite"]').textContent = texts.pageModeInfinite;

    // Êõ¥Êñ∞ÊúÄÂ§ßËÆ∞ÂΩïÊï∞ÁöÑÂçï‰ΩçÊòæÁ§∫
    const maxRecentValue = document.getElementById('maxRecent').value;
    const unitText = language === 'zh' ? 'Êù°' : '';
    document.getElementById('maxRecentTooltip').textContent = `${maxRecentValue}${unitText}`;

    // Êõ¥Êñ∞ÂºπÁ™óÂÆΩÂ∫¶ÁöÑÂçï‰ΩçÊòæÁ§∫
    const popupWidthValue = document.getElementById('popupWidth').value;
    const pixelText = language === 'zh' ? 'ÂÉèÁ¥†' : 'px';
    document.getElementById('popupWidthTooltip').textContent = `${popupWidthValue}${pixelText}`;
}

function applyTheme(theme) {
    if (theme === 'system') {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
        document.documentElement.removeAttribute('data-force-theme');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
        document.documentElement.setAttribute('data-force-theme', theme);
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    const themeSelect = document.getElementById('themeSelect');
    const maxRecentInput = document.getElementById('maxRecent');
    const maxRecentSlider = document.getElementById('maxRecentSlider');
    const maxRecentTooltip = document.getElementById('maxRecentTooltip');
    const popupWidthInput = document.getElementById('popupWidth');
    const popupWidthSlider = document.getElementById('popupWidthSlider');
    const popupWidthTooltip = document.getElementById('popupWidthTooltip');
    const languageSelect = document.getElementById('languageSelect');
    const showTabCountCheckbox = document.getElementById('showTabCount');
    const navigationPositionSelect = document.getElementById('navigationPosition');
    const pageModeSelect = document.getElementById('pageMode');
    
    // Ëé∑Âèñ‰øùÂ≠òÁöÑËÆæÁΩÆ
    const { theme: savedTheme = 'system', maxRecent = 100, popupWidth = 500, language: savedLanguage = 'en', showTabCount = true, navigationPosition = 'top', pageMode = 'pagination' } = await chrome.storage.sync.get(['theme', 'maxRecent', 'popupWidth', 'language', 'showTabCount', 'navigationPosition', 'pageMode']);
    
    // Á´ãÂç≥Â∫îÁî®‰∏ªÈ¢ò
    themeSelect.value = savedTheme;
    applyTheme(savedTheme);

    // ËÆæÁΩÆÊúÄÂ§ßËÆ∞ÂΩïÊï∞ÁöÑÂÄºÔºàËÄÉËôëÊªëÂùóÂíåËæìÂÖ•Ê°ÜÔºâ
    const maxRecentValue = Math.max(1, Math.min(20000, maxRecent));
    maxRecentInput.value = maxRecentValue;
    maxRecentSlider.value = maxRecentValue / 1000;
    updateSliderBackground(maxRecentSlider, maxRecentSlider.value);
    maxRecentTooltip.textContent = `${maxRecentValue}Êù°`;

    // ËÆæÁΩÆÂºπÁ™óÂÆΩÂ∫¶ÁöÑÂÄºÔºàËÄÉËôëÊªëÂùóÂíåËæìÂÖ•Ê°ÜÔºâ
    const popupWidthValue = Math.max(300, Math.min(800, popupWidth));
    popupWidthInput.value = popupWidthValue;
    popupWidthSlider.value = Math.round((popupWidthValue - 300) / 31.25);
    updateSliderBackground(popupWidthSlider, popupWidthSlider.value);
    popupWidthTooltip.textContent = `${popupWidthValue}px`;

    // ËÆæÁΩÆÂàùÂßãËØ≠Ë®ÄÊñáÊú¨
    languageSelect.value = savedLanguage;
    updateLanguageTexts(savedLanguage);

    // ËÆæÁΩÆÊòæÁ§∫Ê†áÁ≠æÈ°µÊï∞ÈáèÁöÑÂÄº
    showTabCountCheckbox.checked = showTabCount;

    // ËÆæÁΩÆÂØºËà™‰ΩçÁΩÆÂíåÈ°µÈù¢Ê®°ÂºèÁöÑÂÄº
    navigationPositionSelect.value = navigationPosition;
    pageModeSelect.value = pageMode;

    // Êõ¥Êñ∞ÊªëÂùóÊ∏êÂèòÊïàÊûúÁöÑÂáΩÊï∞
    function updateSliderBackground(slider, value) {
        const percentage = ((value - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.setProperty('--slider-value', `${percentage}%`);
    }

    // ÂàùÂßãÂåñÊó∂Êõ¥Êñ∞ÊªëÂùóÊ∏êÂèò
    updateSliderBackground(maxRecentSlider, maxRecentValue / 1000);
    updateSliderBackground(popupWidthSlider, (popupWidthValue - 300) / 30);

    // ‰∏ªÈ¢òÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
    themeSelect.addEventListener('change', async () => {
        const selectedTheme = themeSelect.value;
        await chrome.storage.sync.set({ theme: selectedTheme });
        applyTheme(selectedTheme);
    });

    // ÊúÄÂ§ßËÆ∞ÂΩïÊï∞ÊªëÂùóÂíåËæìÂÖ•Ê°ÜËÅîÂä®
    maxRecentSlider.addEventListener('input', async () => {
        const value = Math.round(maxRecentSlider.value * 1000);
        maxRecentInput.value = value;
        const { language: currentLanguage = 'en' } = await chrome.storage.sync.get('language');
        const unitText = currentLanguage === 'zh' ? 'Êù°' : '';
        maxRecentTooltip.textContent = `${value}${unitText}`;
        updateSliderBackground(maxRecentSlider, maxRecentSlider.value);
        await chrome.storage.sync.set({ maxRecent: value });
    });

    // Âª∂ËøüÈ™åËØÅÂíå‰øùÂ≠òÊúÄÂ§ßËÆ∞ÂΩïÊï∞
    let maxRecentTimeout;
    maxRecentInput.addEventListener('input', () => {
        clearTimeout(maxRecentTimeout);
        const value = parseInt(maxRecentInput.value, 10);
        if (!isNaN(value)) {
            if (value < 1 || value > 20000) {
                maxRecentInput.classList.add('error');
            } else {
                maxRecentInput.classList.remove('error');
            }
            maxRecentTimeout = setTimeout(async () => {
                const adjustedValue = Math.max(1, Math.min(20000, value));
                maxRecentInput.value = adjustedValue;
                maxRecentInput.classList.remove('error');
                maxRecentSlider.value = adjustedValue / 1000;
                const { language: currentLanguage = 'en' } = await chrome.storage.sync.get('language');
                const unitText = currentLanguage === 'zh' ? 'Êù°' : '';
                maxRecentTooltip.textContent = `${adjustedValue}${unitText}`;
                updateSliderBackground(maxRecentSlider, maxRecentSlider.value);
                await chrome.storage.sync.set({ maxRecent: adjustedValue });
            }, 1000);
        }
    });

    maxRecentInput.addEventListener('blur', async () => {
        clearTimeout(maxRecentTimeout);
        let value = parseInt(maxRecentInput.value, 10);
        if (isNaN(value) || value < 1) value = 1;
        if (value > 20000) value = 20000;
        maxRecentInput.value = value;
        maxRecentInput.classList.remove('error');
        maxRecentSlider.value = value / 1000;
        const { language: currentLanguage = 'en' } = await chrome.storage.sync.get('language');
        const unitText = currentLanguage === 'zh' ? 'Êù°' : '';
        maxRecentTooltip.textContent = `${value}${unitText}`;
        updateSliderBackground(maxRecentSlider, maxRecentSlider.value);
        await chrome.storage.sync.set({ maxRecent: value });
    });

    // ÂºπÁ™óÂÆΩÂ∫¶ÊªëÂùóÂíåËæìÂÖ•Ê°ÜËÅîÂä®
    popupWidthSlider.addEventListener('input', async () => {
        const value = Math.round(300 + popupWidthSlider.value * 31.25);
        popupWidthInput.value = value;
        const { language: currentLanguage = 'en' } = await chrome.storage.sync.get('language');
        const pixelText = currentLanguage === 'zh' ? 'ÂÉèÁ¥†' : 'px';
        popupWidthTooltip.textContent = `${value}${pixelText}`;
        updateSliderBackground(popupWidthSlider, popupWidthSlider.value);
        await chrome.storage.sync.set({ popupWidth: value });
    });

    // Âª∂ËøüÈ™åËØÅÂíå‰øùÂ≠òÂºπÁ™óÂÆΩÂ∫¶
    let popupWidthTimeout;
    popupWidthInput.addEventListener('input', () => {
        clearTimeout(popupWidthTimeout);
        const value = parseInt(popupWidthInput.value, 10);
        if (!isNaN(value)) {
            if (value < 300 || value > 800) {
                popupWidthInput.classList.add('error');
            } else {
                popupWidthInput.classList.remove('error');
            }
            popupWidthTimeout = setTimeout(async () => {
                const adjustedValue = Math.max(300, Math.min(800, value));
                popupWidthInput.value = adjustedValue;
                popupWidthInput.classList.remove('error');
                popupWidthSlider.value = Math.round((adjustedValue - 300) / 31.25);
                const { language: currentLanguage = 'en' } = await chrome.storage.sync.get('language');
                const pixelText = currentLanguage === 'zh' ? 'ÂÉèÁ¥†' : 'px';
                popupWidthTooltip.textContent = `${adjustedValue}${pixelText}`;
                updateSliderBackground(popupWidthSlider, popupWidthSlider.value);
                await chrome.storage.sync.set({ popupWidth: adjustedValue });
            }, 1000);
        }
    });

    popupWidthInput.addEventListener('blur', async () => {
        clearTimeout(popupWidthTimeout);
        let value = parseInt(popupWidthInput.value, 10);
        if (isNaN(value) || value < 300) value = 300;
        if (value > 800) value = 800;
        popupWidthInput.value = value;
        popupWidthInput.classList.remove('error');
        popupWidthSlider.value = Math.round((value - 300) / 31.25);
        const { language: currentLanguage = 'en' } = await chrome.storage.sync.get('language');
        const pixelText = currentLanguage === 'zh' ? 'ÂÉèÁ¥†' : 'px';
        popupWidthTooltip.textContent = `${value}${pixelText}`;
        updateSliderBackground(popupWidthSlider, popupWidthSlider.value);
        await chrome.storage.sync.set({ popupWidth: value });
    });

    // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (themeSelect.value === 'system') {
            applyTheme('system');
        }
    });

    // ËØ≠Ë®ÄÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
    languageSelect.addEventListener('change', async () => {
        const selectedLanguage = languageSelect.value;
        await chrome.storage.sync.set({ language: selectedLanguage });
        updateLanguageTexts(selectedLanguage);
    });

    // ÊòæÁ§∫Ê†áÁ≠æÈ°µÊï∞ÈáèÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
    showTabCountCheckbox.addEventListener('change', async () => {
        await chrome.storage.sync.set({ showTabCount: showTabCountCheckbox.checked });
    });

    // ÂØºËà™‰ΩçÁΩÆÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
    navigationPositionSelect.addEventListener('change', async () => {
        const selectedPosition = navigationPositionSelect.value;
        await chrome.storage.sync.set({ navigationPosition: selectedPosition });
    });

    // È°µÈù¢Ê®°ÂºèÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
    pageModeSelect.addEventListener('change', async () => {
        const selectedMode = pageModeSelect.value;
        await chrome.storage.sync.set({ pageMode: selectedMode });
    });

    // ÁõëÂê¨Â≠òÂÇ®ÂèòÂåñ
    chrome.storage.onChanged.addListener((changes, namespace) => {
        if (namespace === 'sync' && changes.theme) {
            const newTheme = changes.theme.newValue;
            themeSelect.value = newTheme;
            applyTheme(newTheme);
        }
        if (namespace === 'sync' && changes.maxRecent) {
            const newMaxRecent = changes.maxRecent.newValue;
            maxRecentInput.value = newMaxRecent;
            maxRecentSlider.value = newMaxRecent / 1000;
        }
        if (namespace === 'sync' && changes.popupWidth) {
            const newPopupWidth = changes.popupWidth.newValue;
            popupWidthInput.value = newPopupWidth;
            popupWidthSlider.value = (newPopupWidth - 300) / 30;
        }
        if (namespace === 'sync' && changes.language) {
            const newLanguage = changes.language.newValue;
            languageSelect.value = newLanguage;
            updateLanguageTexts(newLanguage);
        }
        if (namespace === 'sync' && changes.showTabCount) {
            showTabCountCheckbox.checked = changes.showTabCount.newValue;
        }
        if (namespace === 'sync' && changes.navigationPosition) {
            const newNavigationPosition = changes.navigationPosition.newValue;
            navigationPositionSelect.value = newNavigationPosition;
        }
        if (namespace === 'sync' && changes.pageMode) {
            const newPageMode = changes.pageMode.newValue;
            pageModeSelect.value = newPageMode;
        }
    });

    applyTheme(savedTheme);
});

// Êõ¥Êñ∞ÊªëÂùóÂÄºÁöÑÂáΩÊï∞
function updateSliderValue(slider, value, max) {
    const percentage = (value / max) * 100;
    slider.style.setProperty('--slider-value', `${percentage}%`);
}